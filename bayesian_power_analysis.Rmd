---
title: "Preferring Politeness - Bayesian Power Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r load libraries}
library(BayesFactor)
library(dplyr)
library(tibble)
library(tidybayes)
library(ggplot2)
library(tidyr)
library(mgcv)
library(stringi)
library(VGAM)
library(base)
library(brms)
library(broom)
library(glmmfields)
library(generics)
library(broom.mixed)
library(tidyverse)
library(tibble)
```

### Attempt 1

```{r}
#Simulate data. QUESTION: Is the probability of success comparable to the frequentist effect size? Is this the value that we vary to calculate power?

set.seed(3)

d <-tibble(y=rbinom(n=60, size=1, prob=0.8))

str(d)
```

```{r}
#I believe this is used to get the brms default for intercept-only logistic regression model, but I do not understand the output.

get_prior(formula=y|trials(1)~1, data=d, family=binomial)
```

```{r}
#Model with the brm() function, using a more skeptical prior of normal(0, 2).

#y|trials(1)~1 indicates that each y value corresponds to a single trial, which itself corresponds to n=1 portion of the statistical formula.

fit <- brm(data=d, family=binomial, y|trials(1)~1, prior(normal(0,2), class=Intercept), seed=3)
```

```{r}
print(fit)
```

```{r}
#Because the intercept is on the scale of the logit link (the log odds), we can transform it with the brms::inv_logit_scaled() function.

fixef(fit)["Intercept", 1] %>% 
  inv_logit_scaled()
```

```{r}
#Extract the posterior draws and transform from the log-oss to a probability metric.

k <- posterior_samples(fit) %>% 
  transmute(p=inv_logit_scaled(b_Intercept)) #%>% 

k
```
```{r}
#Visualize the probability metric of the posterior draws.

  ggplot(k, aes(x=p)) +
  geom_density(fill="grey30") +
  labs(title="Density of probability of selecting a polite speaker", x="Probability of selecting a polite speaker") +
  scale_x_continuous(limits=c(0, 1)) +
  scale_y_continuous(NULL, breaks=NULL) +
  theme_classic()
```

```{r}
#Calculate the posterior median and 95% credible interval.

posterior_samples(fit1) %>% 
  transmute(p=inv_logit_scaled(b_Intercept)) %>% 
  median_qi()
```

```{r}
#Write a simulation function for the power analysis. QUESTION: What is n_player

sim_data_fit <- function(seed, n_participants) {
  
  n_trials <- 1
  prob_hit <- .5
  
  set.seed(seed)
  
  d <- tibble(y = rbinom(n = n_participants, size = n_trials, prob = prob_hit))
  
  update(fit1, newdata = d, seed = seed) %>% 
  posterior_samples() %>% 
  transmute(p = inv_logit_scaled(b_Intercept)) %>% 
  median_qi() %>% 
  select(.lower:.upper)
  
}
```

```{r}
#Run the simulation.
sim1 <- 
  tibble(seed=1:10) %>% 
  mutate(ci=map(seed, sim_data_fit, n_participants=60)) %>% 
  unnest(cols=c(ci))
```

```{r}
#Compute power. 

#I'm quite sure that there is an error in the code mean(.upper < .5). This was the formula I found online, but I do not understand it so I'm not sure how to fix it.

sim1 %>% 
  mutate(width = .upper - .lower) %>% 
  summarise("power" = mean(.upper < .5))
```
